<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>data.admin.ch - Linked Data Prototype - Mash-Up</title>
        <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
        <script type="text/javascript" src="http://twitter.github.com/typeahead.js/releases/latest/typeahead.bundle.min.js"></script>
    </head>
    <body class="bfs">
        <div id="remote">
            <input class="typeahead" type="text" placeholder="Municipality" id="municipalityName"><button id="show">Show Municipality</button>
        </div>
        <script>

            var bestPictures = new Bloodhound({
                datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                prefetch: '../data/films/post_1960.json',
                remote: {
                    url: 'http://lindas-data.ch/sparql?query=PREFIX+gont%3A+<https%3A%2F%2Fgont.ch%2F>%0D%0A%0D%0ASELECT+DISTINCT+%3Fname+WHERE+{+%0D%0A++%3Fmv+a+gont%3AMunicipalityVersion.%0D%0A++%3Fmv+gont%3AlongName+%3Fname.%0D%0A++%3Fmv+gont%3Amunicipality+%3Fm.%0D%0A++%3Fm+a+gont%3APoliticalMunicipality.%0D%0A++FILTER+regex(%3Fname%2C%27%5E%QUERY%27%2C%27i%27)%0D%0A}&format=application%2Fjson',
                    wildcard: '%QUERY',
                    filter: function (result) {
                        return $.map(result.results.bindings,
                                function (binding) {
                                    return {
                                        value: binding.name.value
                                    }
                                }
                        );
                    }
                }
            });

            $('#remote .typeahead').typeahead(null, {
                name: 'best-pictures',
                display: 'value',
                source: bestPictures
            });

            $('#show').on('click', function () {
                var query = 'PREFIX gont: <https://gont.ch/> SELECT DISTINCT ?m WHERE { \n\
                                ?mv a gont:MunicipalityVersion. \n\
                                ?mv gont:longName "'+$('#municipalityName').val()+'". \n\
                                ?mv gont:municipality ?m.}'
                $.ajax({
                    type: "GET",
                    headers: {"Accept": "application/sparql-results+json"},
                    data: {query: query
                    },
                    dataType: "json",
                    url: "http://lindas-data.ch/sparql/",
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log(textStatus + ': ' + errorThrown)
                    }}).done(
                        function (data) {
                            if (data.results.bindings.length < 1) {
                                alert("No such municipality");
                            } else {
                                alert(data.results.bindings[0].m.value);
                            }
                        });
            });

        </script>

    </body>
</html>
